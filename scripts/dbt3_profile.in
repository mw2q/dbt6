#!/bin/sh

#
# This file is released under the terms of the Artistic License.
# Please see # the file LICENSE, included in this package, for details.
#
# Copyright (C) 2002 Jenny Zhang & Open Source Development Lab, Inc.
#

DIR=`dirname $0`

export DBT3_HOME="@TOPDIR@"
export DATABASE=@DATABASE_TO_USE@

export DSS_QUERY="@TOPDIR@/queries"
export DSS_PATH="${HOME}/local/data"
export DSS_CONFIG="@TOPDIR@/src/dbgen"
export DBT3_PERL_MODULE="@TOPDIR@/perlmodules"

export DBGEN="${DSS_CONFIG}/dbgenssbm"
export QGEN="${DSS_CONFIG}/qgen"
export PARSE_QUERY="@TOPDIR@/src/parse_query"
export POWER="@TOPDIR@/src/power"

source @TOPDIR@/scripts/${DATABASE}/${DATABASE}_profile

clearprof () {
	sudo /usr/sbin/readprofile -m /boot/System.map-`uname -r` -r
}

getprof () {
	sudo /usr/sbin/readprofile -n -m /boot/System.map-`uname -r` -v | sort -grk3,4 > $OUTPUT_DIR/readprofile.txt
}

clearoprof () {
	sudo opcontrol --vmlinux=/boot/vmlinux
	sleep 2
	sudo opcontrol --start-daemon
	sleep 2
	sudo opcontrol --start
	sleep 2
	# If opcontrol ever gets stuck here, sometimes it helps to remove
	# everything in this dir:
	# /var/lib/oprofile
	sudo opcontrol --reset
}

getoprof () {
	mkdir -p $OUTPUT_DIR/oprofile/annotate
	sudo opcontrol --dump
	sudo opreport -l -o $OUTPUT_DIR/oprofile/oprofile.txt
	sudo opcontrol --stop
	sudo opcontrol --shutdown
	sudo opannotate --source --assembly > $OUTPUT_DIR/oprofile/assembly.txt 2>&1
	sudo opannotate --source --output-dir=$OUTPUT_DIR/oprofile/annotate
	sudo opreport -l -c -p /lib/modules/`uname -r` -o ${OUTPUT_DIR}/oprofile/call-graph.txt > /dev/null 2>&1
}

perf_start()
{
	DIR=${1}

	mkdir -p ${DIR}
	sudo perf record -o ${DIR}/perf.data -a -g -s sleep 60
}

perf_collect()
{
	DIR=${1}

	echo "Generating perf report..."
	sudo perf report -i ${DIR}/perf.data -n > ${DIR}/perf-report.txt &

	echo "Generating perf annotated source..."
	sudo perf annotate -l -P -i ${DIR}/perf.data > ${DIR}/perf-annotate.txt &

	echo "Generating perf trace on..."
	sudo perf script -L -i ${DIR}/perf.data > ${DIR}/perf-trace.txt &
}
